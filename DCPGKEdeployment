//noinspections GroovyAssignabilityCheck

pipeline {
    agent any
    
    stages {
        stage('Deploying application into GKE'){
        when {
            expression { ! params.destroy }
        }
        steps{
            script {
            def buildNumber = Jenkins.instance.getItem('PetclinicDeployment').lastSuccessfulBuild.number
            print buildNumber
            sh '''#!/bin/bash -l
            whoami
            sudo su - dhemanth
            echo "Hemanth"
            whoami
            gcloud auth list  
            gcloud config set account dcp-service-account@ford-project-319713.iam.gserviceaccount.com
            gcloud container clusters get-credentials dcp-gke --region us-east1 --project ford-project-319713
            OUT=$(kubectl get pods -n powertrain-gke-prod | grep powertrain | awk '{print $1}')
            echo $OUT

            if [ "$OUT" == "powertrain" ]
            then
                    
                    sed -i "s/@IMG_TAG@/'''+ buildNumber +'''/g" "${WORKSPACE}/gke-deployment.yaml"
                    kubectl replace -f gke-deployment.yaml
            else
                    
                    sed -i "s/@IMG_TAG@/'''+ buildNumber +'''/g" "${WORKSPACE}/gke-deployment.yaml"
                    kubectl apply -f gke-deployment.yaml
            fi  
        
            '''
        }
        }
        }
    }
}
